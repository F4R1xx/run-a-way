<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunAWay - Painel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { 
            --glow-color: #FF7700; 
            --background-color: #282828;
            --card-color: #333333;
            --text-color: #E0E0E0;
            --scanline-bg: #202020;
        }
        body { 
            font-family: 'Chakra Petch', sans-serif; 
            background-color: var(--scanline-bg); 
            color: var(--text-color); 
        }
        .content-card {
            background-color: rgba(40, 40, 40, 0.8);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: float-in 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes float-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .xp-bar-container { background-color: rgba(0,0,0,0.3); border-radius: 9999px; height: 1rem; overflow: hidden; border: 1px solid rgba(255, 119, 0, 0.2); }
        .xp-bar-fill { background-color: var(--glow-color); height: 100%; border-radius: 9999px; box-shadow: 0 0 10px var(--glow-color); transition: width 0.5s ease-in-out; }
        .action-button { background-color: var(--glow-color); color: #111; border-radius: 0.75rem; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .action-button:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 119, 0, 0.8); }
        
        .calendar-day { height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; transition: all 0.2s ease; position: relative; cursor: pointer; }
        .calendar-day:not(.other-month):hover { background-color: rgba(255,255,255,0.1); }
        .calendar-day.other-month { color: #666; cursor: default; }
        .calendar-day.today { border: 2px solid var(--glow-color); }
        .calendar-day.has-walk { background-color: var(--glow-color); color: #111; font-weight: bold; box-shadow: 0 0 10px var(--glow-color); }
        #walk-popover { background-color: #1a1a1a; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 280px; pointer-events: none; }

        .achievement-icon-display {
            border: 2px solid;
            transition: all 0.3s ease;
        }
        .achievement-icon-display.gold { border-color: #ffd700; color: #ffd700; box-shadow: 0 0 15px #ffd700; }
        .achievement-icon-display.silver { border-color: #c0c0c0; color: #c0c0c0; box-shadow: 0 0 15px #c0c0c0; }
        .achievement-icon-display.bronze { border-color: #cd7f32; color: #cd7f32; box-shadow: 0 0 15px #cd7f32; }

        .fab-button {
            background-color: var(--glow-color);
            color: #111;
            transition: all 0.3s ease;
        }
        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px var(--glow-color);
        }
    </style>
</head>
<body class="h-screen">

    <div id="app-content" class="flex w-full h-full">
        <button id="menu-open-btn" class="md:hidden fixed top-6 left-6 z-50 text-white bg-black/20 p-2 rounded-md"><i class="fas fa-bars text-xl"></i></button>
        <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 w-64 bg-black/30 backdrop-blur-sm p-6 flex flex-col z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <button id="menu-close-btn" class="md:hidden absolute top-6 right-6 text-white"><i class="fas fa-times text-2xl"></i></button>
            <div class="flex items-center gap-4 mt-8 md:mt-0">
                <i class="fas fa-user-circle text-4xl text-gray-400"></i>
                <div>
                    <h2 id="user-name-sidebar" class="font-bold text-lg text-white">Carregando...</h2>
                    <a href="./perfil.html" class="text-sm text-gray-400 hover:text-orange-400">Seu Perfil</a>
                </div>
            </div>
            <nav class="mt-10 flex flex-col gap-4">
                <a href="./home.html" class="text-lg font-semibold text-orange-400 transition-colors">Painel</a>
                <a href="./cadastrar-caminhada.html" class="text-lg font-semibold hover:text-orange-400 transition-colors">Registrar Atividade</a>
                <a href="./minhas-caminhadas.html" class="text-lg font-semibold hover:text-orange-400 transition-colors">Ver Caminhadas</a>
                <a href="./graficos.html" class="text-lg font-semibold hover:text-orange-400 transition-colors">Gráficos</a>
                <a href="./conquistas.html" class="text-lg font-semibold hover:text-orange-400 transition-colors">Conquistas</a>
            </nav>
            <div class="mt-auto">
                <button id="logout-btn" class="w-full flex items-center justify-center gap-3 px-4 py-3 font-semibold rounded-lg text-red-500 hover:bg-red-500 hover:text-white transition-colors"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold tracking-wider text-white">Painel de Controle</h1>
                    <p class="mt-1 text-lg text-gray-300">Bem-vindo(a) de volta, <span id="user-name-main" class="font-bold text-white">...</span></p>
                </div>
                <div class="w-full md:w-72 mt-4 md:mt-0">
                    <div class="flex justify-between items-center mb-1">
                        <span id="level-display" class="font-semibold text-white">Nível 1</span>
                        <span id="xp-display" class="text-sm text-gray-400">(0/100)</span>
                    </div>
                    <div class="xp-bar-container"><div id="xp-bar-fill" class="xp-bar-fill" style="width: 0%;"></div></div>
                </div>
            </header>

            <div class="mt-8 grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-2 content-card" style="animation-delay: 100ms;">
                    <div id="calendar-header" class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="month-year-display" class="text-xl font-bold text-white uppercase tracking-wider"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-400 mb-2 text-xs">
                        <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SAB</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>

                <div class="content-card flex flex-col" style="animation-delay: 200ms;">
                     <h3 class="font-bold text-white text-lg mb-4">Troféus em Destaque</h3>
                     <div id="top-achievements-container" class="flex-1 flex flex-col items-center justify-center gap-4">
                        <!-- Top achievements will be inserted here -->
                     </div>
                     <a href="./conquistas.html" class="text-center text-sm font-semibold text-orange-400 hover:underline mt-4">Ver todos</a>
                </div>

                <div class="content-card flex flex-col justify-between" style="animation-delay: 300ms;">
                    <h3 class="font-bold text-white text-lg">RESUMO DO MÊS</h3>
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-gray-400">Dias Ativos<span id="summary-days" class="block text-2xl font-bold text-white">0</span></p>
                            <p class="text-gray-400 mt-3">Calorias<span id="summary-calories" class="block text-2xl font-bold text-white">0</span></p>
                            <p class="text-gray-400 mt-3">Distância<span id="summary-km" class="block text-2xl font-bold text-white">0 km</span></p>
                        </div>
                        <div><i id="fire-icon" class="fas fa-fire text-8xl text-gray-600 transition-colors"></i></div>
                    </div>
                </div>
                
                <div class="lg:col-span-4 content-card" style="animation-delay: 400ms;">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-white text-lg">Últimas Atividades</h3>
                        <a href="./minhas-caminhadas.html" class="text-sm font-semibold text-orange-400 hover:underline">Ver todas</a>
                    </div>
                    <div id="walks-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="no-walks-message" class="hidden mt-4 text-center py-8">
                        <p class="text-gray-400">Nenhuma caminhada registrada ainda.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="walk-popover" class="hidden absolute z-20 p-3 rounded-lg content-card"></div>
        
        <a href="./cadastrar-caminhada.html" class="fab-button fixed bottom-8 right-8 w-16 h-16 rounded-full flex items-center justify-center shadow-lg z-30">
            <i class="fas fa-plus text-3xl"></i>
        </a>
    </div>

    <script type="module">
        import { auth, database } from './firebase.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { ref, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { allAchievements } from './achievements.js';

        const appContent = document.getElementById('app-content');
        const userNameSidebar = document.getElementById('user-name-sidebar');
        const userNameMain = document.getElementById('user-name-main');
        const logoutBtn = document.getElementById('logout-btn');
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const xpBarFill = document.getElementById('xp-bar-fill');
        const summaryDays = document.getElementById('summary-days');
        const summaryCalories = document.getElementById('summary-calories');
        const summaryKm = document.getElementById('summary-km');
        const fireIcon = document.getElementById('fire-icon');
        const sidebar = document.getElementById('sidebar');
        const menuOpenBtn = document.getElementById('menu-open-btn');
        const menuCloseBtn = document.getElementById('menu-close-btn');
        const walksContainer = document.getElementById('walks-container');
        const noWalksMessage = document.getElementById('no-walks-message');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const walkPopover = document.getElementById('walk-popover');
        const topAchievementsContainer = document.getElementById('top-achievements-container');
        
        let currentDate = new Date();
        let allUserWalks = {};

        menuOpenBtn.addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); });
        menuCloseBtn.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); });
        logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Logout Error:", error)));
        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

        const getXpForNextLevel = (level) => {
            const levelCap = 50;
            const fixedXpAfterCap = 1000;
            if (level >= levelCap) return fixedXpAfterCap;
            const baseXP = 100;
            const incrementPerLevel = 18;
            return Math.floor(baseXP + (level - 1) * incrementPerLevel);
        };

        const renderCalendar = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearDisplay.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${year}`;
            calendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                dayDiv.dataset.date = dateString;
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayDiv.classList.add('today');
                }
                if (allUserWalks[dateString]) {
                    dayDiv.classList.add('has-walk');
                }
                calendarGrid.appendChild(dayDiv);
            }
        };

        const renderRecentWalksCards = (walks) => {
            walksContainer.innerHTML = '';
            const walksArray = Object.values(walks).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const recentWalks = walksArray.slice(0, 3);
            recentWalks.forEach(walk => {
                const [year, month, day] = walk.date.split('-');
                const formattedDate = `${day}/${month}/${year}`;
                const card = `
                    <div class="bg-black/20 p-4 rounded-lg">
                        <p class="font-bold text-white">${formattedDate}</p>
                        <p class="text-sm text-gray-400 mt-2">Duração <span class="block text-white font-semibold">${walk.duration}</span></p>
                        <p class="text-sm text-gray-400 mt-2">Distância (km) <span class="block text-white font-semibold">${walk.distance.toFixed(2)}</span></p>
                        <p class="text-sm text-gray-400 mt-2">Calorias <span class="block text-white font-semibold">${walk.calories}</span></p>
                        <p class="mt-2 font-bold text-orange-400">+${walk.xpGained || 0}XP</p>
                    </div>
                `;
                walksContainer.innerHTML += card;
            });
        };

        const calculateMonthSummary = (walks) => {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const walksThisMonth = Object.values(walks).filter(walk => {
                const walkDate = new Date(walk.date);
                return walkDate.getMonth() === currentMonth && walkDate.getFullYear() === currentYear;
            });
            if (walksThisMonth.length > 0) {
                const totalKm = walksThisMonth.reduce((sum, walk) => sum + walk.distance, 0);
                const totalCalories = walksThisMonth.reduce((sum, walk) => sum + walk.calories, 0);
                const uniqueDays = new Set(walksThisMonth.map(walk => walk.date)).size;
                summaryKm.textContent = `${totalKm.toFixed(2)} km`;
                summaryCalories.textContent = totalCalories;
                summaryDays.textContent = uniqueDays;
                fireIcon.classList.replace('text-gray-600', 'text-orange-500');
                fireIcon.style.textShadow = '0 0 20px var(--glow-color)';
            } else {
                summaryKm.textContent = '0 km';
                summaryCalories.textContent = '0';
                summaryDays.textContent = '0';
                fireIcon.classList.replace('text-orange-500', 'text-gray-600');
                fireIcon.style.textShadow = 'none';
            }
        };
        
        const renderTopAchievements = (userData) => {
            const unlockedIds = userData.achievements ? Object.keys(userData.achievements) : [];
            if (unlockedIds.length === 0) {
                topAchievementsContainer.innerHTML = `<p class="text-gray-500 text-center">Nenhuma conquista desbloqueada ainda. Continue assim!</p>`;
                return;
            }

            const tierOrder = { gold: 0, silver: 1, bronze: 2 };
            const unlockedAchievements = allAchievements
                .filter(ach => unlockedIds.includes(ach.id))
                .sort((a, b) => tierOrder[a.tier] - tierOrder[b.tier]);
            
            const top3 = unlockedAchievements.slice(0, 3);
            
            topAchievementsContainer.innerHTML = '';
            top3.forEach(ach => {
                const achElement = `
                    <div class="flex items-center gap-4 w-full">
                        <div class="achievement-icon-display ${ach.tier} w-16 h-16 rounded-full flex items-center justify-center text-3xl flex-shrink-0">
                            <i class="fas ${ach.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-white">${ach.title}</p>
                            <p class="text-xs text-gray-400">${ach.description}</p>
                        </div>
                    </div>
                `;
                topAchievementsContainer.innerHTML += achElement;
            });
        };

        const updateDashboard = (userData) => {
            const fullName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            userNameSidebar.textContent = fullName || 'Agente';
            userNameMain.textContent = fullName || 'Agente';
            const level = userData.lvl || 1;
            const currentXp = userData.xp || 0;
            const xpForNextLevel = getXpForNextLevel(level);
            xpDisplay.textContent = `(${currentXp}/${xpForNextLevel})`;
            levelDisplay.textContent = `Nível ${level}`;
            xpBarFill.style.width = `${(currentXp / xpForNextLevel) * 100}%`;
            const walks = userData.walks || {};
            allUserWalks = {};
            for (const key in walks) {
                const walk = walks[key];
                if (!allUserWalks[walk.date]) allUserWalks[walk.date] = [];
                allUserWalks[walk.date].push(walk);
            }
            if (Object.keys(walks).length > 0) {
                walksContainer.classList.remove('hidden');
                noWalksMessage.classList.add('hidden');
                renderRecentWalksCards(walks);
            } else {
                walksContainer.classList.add('hidden');
                noWalksMessage.classList.remove('hidden');
            }
            renderCalendar();
            calculateMonthSummary(walks);
            renderTopAchievements(userData);
        };

        calendarGrid.addEventListener('mouseover', (e) => {
            const dayElement = e.target.closest('.calendar-day');
            if (dayElement && dayElement.classList.contains('has-walk')) {
                const date = dayElement.dataset.date;
                const walksOnDay = allUserWalks[date];
                const totalKm = walksOnDay.reduce((sum, walk) => sum + walk.distance, 0);
                const totalCalories = walksOnDay.reduce((sum, walk) => sum + walk.calories, 0);
                const totalXp = walksOnDay.reduce((sum, walk) => sum + (walk.xpGained || 0), 0);
                const [y, m, d] = date.split('-');
                walkPopover.innerHTML = `<p class="font-bold text-white text-lg border-b border-gray-600 pb-2 mb-2">${d}/${m}/${y}</p><p class="text-sm text-gray-300">Distância: <span class="font-bold text-white">${totalKm.toFixed(2)} km</span></p><p class="text-sm text-gray-300">Calorias: <span class="font-bold text-white">${totalCalories}</span></p><p class="text-sm text-orange-400">XP Ganho: <span class="font-bold">+${totalXp}</span></p>`;
                const rect = dayElement.getBoundingClientRect();
                walkPopover.style.left = `${rect.left + window.scrollX}px`;
                walkPopover.style.top = `${rect.bottom + window.scrollY + 5}px`;
                walkPopover.classList.remove('hidden');
            }
        });
        calendarGrid.addEventListener('mouseout', (e) => {
             const dayElement = e.target.closest('.calendar-day');
             if(dayElement) {
                walkPopover.classList.add('hidden')
             };
        });
        
        calendarGrid.addEventListener('click', (e) => {
            const dayElement = e.target.closest('.calendar-day');
            if (dayElement && !dayElement.classList.contains('other-month')) {
                const date = dayElement.dataset.date;
                window.location.href = `./cadastrar-caminhada.html?date=${date}`;
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = ref(database, 'users/' + user.uid);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    updateDashboard(snapshot.val());
                } else {
                    window.location.href = './index.html';
                }
            } else {
                window.location.href = './index.html';
            }
        });
    </script>
</body>
</html>
